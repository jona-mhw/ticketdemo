{% extends "base.html" %}
{% from "tickets/_ticket_table.html" import render_ticket_table %}

{% block title %}Panel de Visualización de Tickets{% endblock %}

{% block page_title %}Panel de Visualización{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Filters -->
    <div class="bg-white shadow rounded-lg p-6">
        <form method="GET" class="space-y-4">
            <!-- First row of filters -->
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-64">
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Buscar</label>
                    <input type="text" id="search" name="search" value="{{ filters.search }}"
                           placeholder="ID, nombre del paciente o RUT"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                </div>
                <div class="min-w-48">
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                    <select id="status" name="status" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                        <option value="">Todos los estados</option>
                        <option value="Vigente" {% if filters.status == 'Vigente' %}selected{% endif %}>Vigente</option>
                        <option value="Anulado" {% if filters.status == 'Anulado' %}selected{% endif %}>Anulado</option>
                    </select>
                </div>
                <div class="min-w-48">
                    <label for="surgery" class="block text-sm font-medium text-gray-700 mb-1">Cirugía</label>
                    <select id="surgery" name="surgery" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                        <option value="">Todas las cirugías</option>
                        {% for surgery in surgeries %}
                        <option value="{{ surgery.id }}" {% if filters.surgery == surgery.id|string %}selected{% endif %}>
                            {{ surgery.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- Second row of filters -->
            <div class="flex flex-wrap gap-4">
                <div class="min-w-40">
                    <label for="date_from" class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                    <input type="date" id="date_from" name="date_from" value="{{ filters.date_from }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                </div>
                <div class="min-w-40">
                    <label for="date_to" class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                    <input type="date" id="date_to" name="date_to" value="{{ filters.date_to }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                </div>
                <div class="min-w-48">
                    <label for="compliance" class="block text-sm font-medium text-gray-700 mb-1">Cumplimiento FPA</label>
                    <select id="compliance" name="compliance" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                        <option value="">Todos</option>
                        <option value="compliant" {% if filters.compliance == 'compliant' %}selected{% endif %}>Cumplió</option>
                        <option value="non_compliant" {% if filters.compliance == 'non_compliant' %}selected{% endif %}>No Cumplió</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button type="submit" 
                            class="bg-primary hover:bg-opacity-90 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Filtrar
                    </button>
                    <a href="{{ url_for('visualizador.dashboard') }}" 
                       class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Limpiar
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Tickets Table -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <h3 class="text-lg font-medium text-gray-900">
                    Tickets ({{ tickets|length }} resultados)
                </h3>
                <div class="flex flex-wrap gap-2">
                    <!-- Column visibility dropdown -->
                    <div x-data="{ open: false }">
                        <button @click="open = !open" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-md text-sm font-medium flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M3 3a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3z"></path></svg>
                            Columnas
                        </button>
                        <div x-show="open" @click.away="open = false" class="absolute mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                            <div id="column-toggles" class="py-1">
                                <!-- Checkboxes will be inserted here by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% if tickets %}
        {{ render_ticket_table(tickets, show_actions=False) }}
        {% else %}
        <div class="px-6 py-12 text-center">
            <h3 class="mt-2 text-sm font-medium text-gray-900">No hay tickets</h3>
            <p class="mt-1 text-sm text-gray-500">No se encontraron tickets que coincidan con los filtros aplicados.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

