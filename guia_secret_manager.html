<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía de Despliegue Seguro con Secret Manager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f9f9f9;
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        code {
            background-color: #e8e8e8;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "Courier New", Courier, monospace;
            word-wrap: break-word;
        }
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .info {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        li {
            margin-bottom: 10px;
        }
        strong {
            color: #c0392b;
        }
    </style>
</head>
<body>

    <h1>Guía de Despliegue Seguro en Google Cloud Run con Secret Manager</h1>
    <p>
        Esta guía explica el método recomendado para manejar credenciales, como la URL de tu base de datos, al desplegar la aplicación. 
        Almacenar secretos directamente en los comandos de despliegue es riesgoso; Secret Manager es la solución profesional de Google Cloud para este problema.
    </p>

    <h2>Paso 1: Asegurar la Contraseña Correcta en Supabase</h2>
    <p>Para evitar cualquier duda, siempre es una buena práctica empezar con una contraseña conocida y segura.</p>
    <ol>
        <li>Ve a tu <strong>Dashboard de Supabase</strong> > <strong>Project Settings</strong> > <strong>Database</strong>.</li>
        <li>En la sección "Connection info", haz clic en <strong>"Reset database password"</strong>.</li>
        <li>Copia y guarda esta nueva contraseña. La usarás en el siguiente paso.</li>
    </ol>

    <h2>Paso 2: Crear y Poblar el Secreto en Google Cloud</h2>
    <p>Estos comandos se ejecutan en tu terminal local, donde tienes configurado `gcloud`.</p>
    
    <h3>2.1. Crear el Contenedor del Secreto</h3>
    <p>Este comando crea un "secreto" vacío que actuará como un contenedor seguro para nuestra URL de la base de datos.</p>
    <pre><code>gcloud secrets create tickethome-db-url --replication-policy="automatic"</code></pre>

    <h3>2.2. Guardar la URL de la Base de Datos en el Secreto</h3>
    <p>Aquí es donde usas la nueva contraseña. El siguiente comando inserta de forma segura la URL completa de tu base de datos dentro del secreto que acabamos de crear.</p>
    <p><strong>Reemplaza `[TU_NUEVA_CONTRASEÑA]`</strong> con la contraseña que obtuviste de Supabase.</p>
    <pre><code>printf 'postgresql://postgres:[TU_NUEVA_CONTRASEÑA]@db.vwdujeylaytybxdwqnsz.supabase.co:5432/postgres' | gcloud secrets versions add tickethome-db-url --data-file=-</code></pre>

    <h2>Paso 3: Conceder Permisos a Cloud Run</h2>
    <p>Ahora, necesitamos darle permiso a nuestro servicio de Cloud Run para que pueda leer el secreto que creamos.</p>

    <h3>3.1. Obtener el Email de la Cuenta de Servicio</h3>
    <p>Cada servicio de Cloud Run tiene una identidad (una cuenta de servicio). Ejecuta esto para obtenerla:</p>
    <pre><code>gcloud run services describe tickethome-demo --region us-central1 --format 'value(serviceAccountName)'</code></pre>
    <p>Copia el email que aparece en la terminal (será algo como `...-compute@developer.gserviceaccount.com`).</p>

    <h3>3.2. Asignar el Permiso</h3>
    <p>Usa el email que acabas de copiar en el siguiente comando para darle acceso de "lector de secretos".</p>
    <p><strong>Reemplaza `[EL_EMAIL_QUE_COPIASTE]`</strong> con el valor real.</p>
    <pre><code>gcloud secrets add-iam-policy-binding tickethome-db-url --member="serviceAccount:[EL_EMAIL_QUE_COPIASTE]" --role="roles/secretmanager.secretAccessor"</code></pre>

    <h2>Paso 4: El Nuevo Comando de Despliegue</h2>
    <p>¡Todo listo! A partir de ahora, este es tu nuevo comando de despliegue. Es más corto, limpio y, sobre todo, más seguro, porque la contraseña ya no viaja en el comando.</p>
    <div class="info">
        <p>Este comando le dice a Cloud Run: "Para la variable de entorno `DATABASE_URL`, no te daré el valor directamente; en su lugar, ve y búscalo en la última versión del secreto llamado `tickethome-db-url`".</p>
    </div>
    <pre><code>gcloud run deploy tickethome-demo --source . --region us-central1 --allow-unauthenticated --update-secrets=DATABASE_URL=tickethome-db-url:latest</code></pre>

</body>
</html>